<div id="inline-bot-root"></div>
<style>
  #inline-bot-root {
    margin-top: 0.5rem;
    pointer-events: none;
    position: relative;
    width: 100%;
    z-index: 1000;
    @media screen and (min-width: 1200px) {
      margin-top: 1rem;
    }
    > * {
      font-family: montserrat, sans-serif;
    }
  }
  .inline-bot-widget {
    background: white;
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
    display: flex;
    flex-direction: column;
    font-family: montserrat, sans-serif,-apple-system, BlinkMacSystemFont, 'Segue UI', 'Roboto', sans-serif;
    overflow: hidden;
    pointer-events: all;
    position: relative;
    width: 100%;
  }
  .inline-bot-header {
    background: #3D0F9A;
    color: white;
    text-align: left;
    padding: 16px 32px;
    font-size: 22px;
    font-weight: 600;
    user-select: none;
  }
  .inline-bot-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    border-left: 1px solid #E6E6E6;
    border-right: 1px solid #E6E6E6;
    box-sizing: border-box;
    min-height: 245px;
    /* Stylized scrollbar to match site */
    scrollbar-color: #75717D #E6E6E6;
    scrollbar-width: thin;
  }
  .inline-bot-messages::-webkit-scrollbar {
    appearance: none;
    height: 6px;
    width: 6px;
  }
  .inline-bot-messages::-webkit-scrollbar-thumb {
    background-color: #ff5a00;
    border-radius: 3px;
  }
  .inline-bot-messages::-webkit-scrollbar-track-piece {
    background-color: #2c2c2c;
  }
  .inline-bot-message {
    max-width: 80%;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .inline-bot-message.user {
    align-self: flex-end;
    align-items: flex-end;
  }
  .inline-bot-message.bot {
    align-self: flex-start;
    align-items: flex-start;
  }
  .inline-bot-message-content {
    padding: 12px 16px;
    border-radius: 30px;
    word-wrap: break-word;
    /*line-height: 1;*/
    font-size: 18px;
  }
  .inline-bot-message.user .inline-bot-message-content {
    background: #F6F7FC;
    color: #3C3A40;
    padding: 12px 32px;
  }
  .inline-bot-message.bot .inline-bot-message-content {
    /* background: white; */
    /* border: 1px solid #e5e7eb; */
    color: #3C3A40;
  }
  .inline-bot-message.bot.error .inline-bot-message-content {
    background: #fef2f2;
    color: #dc2626;
    border: 1px solid #fecaca;
  }
  .inline-bot-input-container {
    padding: 32px 32px;
    background: white;
    border-top: 1px solid #e5e7eb;
    border-left: 1px solid #E6E6E6;
    border-right: 1px solid #E6E6E6;
    border-bottom: 1px solid #E6E6E6;
    /*line-height: 1.5;*/
    display: flex;
    gap: 12px;
    align-items: flex-end;
  }
  .inline-bot-input {
    flex: 1;
    border: 1px solid #d1d5db;
    border-radius: 20px;
    padding: 15px 16px 9px 32px;
    font-size: 16px;
    color: #75717D;
    outline: none;
    opacity: .8;
    resize: none;
    transition: border-color 0.2s;
  }
  .inline-bot-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  .inline-bot-send-button {
    background: #3D0F9A;
    border: none;
    border-radius: 50%;
    width: 52px;
    height: 52px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s;
  }
  .inline-bot-send-button:hover:not(:disabled) {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(61, 15, 154, 0.4);
  }
  .inline-bot-send-button:disabled {
    background: #d1d5db;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  .inline-bot-welcome-message {
    text-align: center;
    color: #6b7280;
    padding: 20px;
    font-size: 18px;
    font-weight: 400;
    border-radius: 12px;
    margin: auto;
    max-width: 400px;
  }
  .inline-bot-typing-indicator {
    display: flex;
    gap: 4px;
    align-items: center;
    padding: 8px;
  }
  .inline-bot-typing-indicator span {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #9ca3af;
    animation: typing 1.4s infinite ease-in-out;
  }
  .inline-bot-typing-indicator span:nth-child(1) {
    animation-delay: -0.32s;
  }
  .inline-bot-typing-indicator span:nth-child(2) {
    animation-delay: -0.16s;
  }
  .references {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #e5e7eb;
    color: #6b7280;
  }
  .references strong {
    color: #374151;
    display: block;
    margin-bottom: 4px;
  }
  .references ol {
    margin: 0;
    padding-left: 16px;
    color: #374151;
  }
  .references li {
    margin-bottom: 2px;
  }
  .references li::marker {
    font-size: 18px;
  }
  .references a {
    color: #667eea;
    text-decoration: none;
    word-break: break-all;
    font-size: 18px;
  }
  .references a:hover {
    text-decoration: underline;
  }
  @keyframes typing {
    0%, 80%, 100% {
      transform: scale(0.8);
      opacity: 0.5;
    }
    40% {
      transform: scale(1);
      opacity: 1;
    }
  }
</style>

<script>
  (function () {
    var ORGANIZATION_ID = 'd0b90198-ed39-72a4-c676-551bc4a3251d';
    var ORGANIZATION_NAME = 'Ivelum';
    var API_URL = 'https://api.stg.flexpressai.com/api';

    // Optional: Try to get values from URL parameters if available (for flexibility)
    try {
      var urlParams = new URLSearchParams(window.location.search);
      var urlOrgId = urlParams.get('organizationId');
      var urlOrgName = urlParams.get('organizationName');
      var urlApiUrl = urlParams.get('apiUrl');

      if (urlOrgId) ORGANIZATION_ID = urlOrgId;
      if (urlOrgName) ORGANIZATION_NAME = urlOrgName;
      if (urlApiUrl) API_URL = urlApiUrl;
    } catch (e) {
      // URL parameter parsing failed, use hardcoded values
      console.log('Using hardcoded configuration values');
    }

    // Widget state
    var messages = [];
    var isLoading = false;
    var root = null;
    var shouldAutoScroll = true;
    var userHasScrolled = false;
    var currentScrollTop = 0;
    var scrollListenerAdded = false;
    var fixedMessagesHeightPx = null;

    // Initialize widget when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initInlineBotWidget);
    } else {
      initInlineBotWidget();
    }

    function initInlineBotWidget() {
      root = document.getElementById('inline-bot-root');
      if (!root) {
        console.warn('Inline Bot Widget: Could not find #inline-bot-root element');
        return;
      }

      createWidget();
      render();
    }

    function createWidget() {
      // Create the widget inside the root element
      var widget = document.createElement('div');
      widget.className = 'inline-bot-widget';
      root.appendChild(widget);

      // Update root reference to point to the actual widget
      root = widget;

      // Organization header
      if (ORGANIZATION_NAME) {
        var header = document.createElement('div');
        header.className = 'inline-bot-header';
        header.textContent = ORGANIZATION_NAME + " Bot";
        root.appendChild(header);
      }

      // Adjust body padding to account for fixed widget
      // document.body.style.paddingTop = '33.33vh';
    }

    function render() {
      if (!root) return;

      // Save current scroll position if user has scrolled
      var existingContainer = root.querySelector('.inline-bot-messages');
      if (existingContainer && userHasScrolled) {
        currentScrollTop = existingContainer.scrollTop;
      }

      // Only clear and rebuild if this is the first render
      if (!root.querySelector('.inline-bot-messages')) {
        // Preserve the header if it exists
        var existingHeader = root.querySelector('.inline-bot-header');
        root.innerHTML = '';

        // Re-add the header if it existed
        if (existingHeader) {
          root.appendChild(existingHeader);
        }
      } else {
        // For subsequent renders, just update the messages container
        var existingMessagesContainer = root.querySelector('.inline-bot-messages');
        if (existingMessagesContainer) {
          updateMessagesOnly(existingMessagesContainer);
          updateSendButtonState();
          smartScroll();
          return;
        }
      }

      // Create widget structure if needed
      if (!root.querySelector('.inline-bot-messages')) {
        initializeWidget();
      }

      var messagesContainer = root.querySelector('.inline-bot-messages');
      if (!messagesContainer) return;

      // Restore scroll position if user had scrolled
      if (userHasScrolled && currentScrollTop > 0) {
        setTimeout(function () {
          messagesContainer.scrollTop = currentScrollTop;
        }, 10);
      }

      // Only update messages content, don't rebuild everything
      messagesContainer.innerHTML = '';

      if (messages.length === 0) {
        var welcomeMsg = document.createElement('div');
        welcomeMsg.className = 'inline-bot-welcome-message';
        welcomeMsg.textContent = 'Hello! How can I help you today?';
        messagesContainer.appendChild(welcomeMsg);
      } else {
        messages.forEach(function (msg, index) {
          var msgEl = document.createElement('div');
          msgEl.className = 'inline-bot-message ' + msg.type + (msg.isError ? ' error' : '');

          var content = document.createElement('div');
          content.className = 'inline-bot-message-content';

          // Show typing indicator for last bot message when loading
          if (msg.type === 'bot' && index === messages.length - 1 && isLoading && !msg.content) {
            var typingIndicator = document.createElement('div');
            typingIndicator.className = 'inline-bot-typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            content.appendChild(typingIndicator);
          } else {
            content.innerHTML = formatMessageContent(msg.content || '', msg.references);
          }

          msgEl.appendChild(content);

          // Add references section for bot messages (only after streaming completes)
          if (msg.type === 'bot' && msg.references && msg.references.length > 0 && !(index === messages.length - 1 && isLoading)) {
            var referencesSection = document.createElement('div');
            referencesSection.className = 'references';
            referencesSection.style.cssText = '\
                        margin-top: 8px;\
                        padding-top: 8px;\
                        border-top: 1px solid #e5e7eb;';

            var referencesTitle = document.createElement('strong');
            referencesTitle.textContent = 'Related:';
            referencesTitle.style.cssText = 'color: #374151; display: block; margin-bottom: 4px;';
            referencesSection.appendChild(referencesTitle);

            var referencesList = document.createElement('ol');
            referencesList.style.cssText = '\
                        margin: 0;\
                        padding-left: 16px;\
                        color: #374151;';

            var maxVisible = 2;
            var hasMore = msg.references.length > maxVisible;

            // Show first 2 references
            msg.references.slice(0, maxVisible).forEach(function (ref) {
              var listItem = document.createElement('li');
              listItem.style.cssText = 'margin-bottom: 2px;';

              var anchor = document.createElement('a');
              anchor.href = ref;
              anchor.target = '_blank';
              anchor.rel = 'noopener noreferrer';
              anchor.textContent = ref;
              anchor.style.cssText = '\
                            color: #667eea;\
                            text-decoration: none;\
                            word-break: break-all;';

              anchor.addEventListener('mouseenter', function () {
                this.style.textDecoration = 'underline';
              });

              anchor.addEventListener('mouseleave', function () {
                this.style.textDecoration = 'none';
              });

              listItem.appendChild(anchor);
              referencesList.appendChild(listItem);
            });

            // Add "More..." link if there are additional references
            if (hasMore) {
              var moreItem = document.createElement('li');
              moreItem.style.cssText = 'margin-bottom: 2px;';

              var moreLink = document.createElement('a');
              moreLink.href = '#';
              moreLink.textContent = 'More... (' + (msg.references.length - maxVisible) + ' additional)';
              moreLink.style.cssText = '\
                            color: #6b7280;\
                            text-decoration: none;\
                            font-style: italic;';

              moreLink.addEventListener('mouseenter', function () {
                this.style.textDecoration = 'underline';
              });

              moreLink.addEventListener('mouseleave', function () {
                this.style.textDecoration = 'none';
              });

              moreLink.addEventListener('click', function (e) {
                e.preventDefault();

                // Remove the "More..." item
                referencesList.removeChild(moreItem);

                // Add remaining references
                msg.references.slice(maxVisible).forEach(function (ref) {
                  var listItem = document.createElement('li');
                  listItem.style.cssText = 'margin-bottom: 2px;';

                  var anchor = document.createElement('a');
                  anchor.href = ref;
                  anchor.target = '_blank';
                  anchor.rel = 'noopener noreferrer';
                  anchor.textContent = ref;
                  anchor.style.cssText = '\
                                    color: #667eea;\
                                    text-decoration: none;\
                                    word-break: break-all;';

                  anchor.addEventListener('mouseenter', function () {
                    this.style.textDecoration = 'underline';
                  });

                  anchor.addEventListener('mouseleave', function () {
                    this.style.textDecoration = 'none';
                  });

                  listItem.appendChild(anchor);
                  referencesList.appendChild(listItem);
                });
              });

              moreItem.appendChild(moreLink);
              referencesList.appendChild(moreItem);
            }

            referencesSection.appendChild(referencesList);
            content.appendChild(referencesSection);
          }

          msgEl.appendChild(content);
          messagesContainer.appendChild(msgEl);
        });
      }

      // Update send button state
      var sendBtn = root.querySelector('.inline-bot-send-button');
      if (sendBtn) {
        sendBtn.disabled = isLoading;
      }

      smartScroll();
    }

    function initializeWidget() {
      // Preserve the header if it exists
      var existingHeader = root.querySelector('.inline-bot-header');
      root.innerHTML = '';

      // Re-add the header if it existed
      if (existingHeader) {
        root.appendChild(existingHeader);
      }

      // Messages container
      var messagesContainer = document.createElement('div');
      messagesContainer.className = 'inline-bot-messages';

      // Add scroll event listener only once with better user scroll detection
      var lastScrollTop = messagesContainer.scrollTop;
      var scrollTimeout = null;

      messagesContainer.addEventListener('scroll', function () {
        var container = this;
        var currentScrollTop = container.scrollTop;
        var threshold = 50; // pixels from bottom
        var distanceFromBottom = container.scrollHeight - container.scrollTop - container.clientHeight;

        // Clear previous timeout
        if (scrollTimeout) {
          clearTimeout(scrollTimeout);
        }

        // Only consider it user scrolling if they moved significantly and it's not at bottom
        if (Math.abs(currentScrollTop - lastScrollTop) > 5 && distanceFromBottom > threshold) {
          userHasScrolled = true;
          shouldAutoScroll = false;

          // Reset auto-scroll after user stops scrolling for 2 seconds
          scrollTimeout = setTimeout(function () {
            if (distanceFromBottom <= threshold) {
              userHasScrolled = false;
              shouldAutoScroll = true;
            }
          }, 2000);
        } else if (distanceFromBottom <= threshold) {
          // User scrolled back to bottom
          userHasScrolled = false;
          shouldAutoScroll = true;
        }

        lastScrollTop = currentScrollTop;
      });

      root.appendChild(messagesContainer);

      // Input container
      var inputContainer = document.createElement('div');
      inputContainer.className = 'inline-bot-input-container';

      var textarea = document.createElement('textarea');
      textarea.className = 'inline-bot-input';
      textarea.placeholder = 'Type your message...';
      textarea.rows = 1;
      textarea.style.borderRadius = '100px';
      textarea.style.borderRadius = '100px';
      textarea.style.resize = 'none';
      textarea.style.overflow = 'hidden';
      textarea.style.lineHeight = '20px';
      textarea.style.minHeight = '52px';
      textarea.style.height = '52px';

      // ScrollHeight-based resize to avoid jitter and preserve single-line height
      function resizeTextarea(el) {
        var minHeight = 52;
        var maxHeight = 120;
        el.style.height = 'auto';
        var newHeight = Math.min(Math.max(el.scrollHeight, minHeight), maxHeight);
        el.style.height = newHeight + 'px';
      }

      // Initial sizing
      resizeTextarea(textarea);

      textarea.addEventListener('input', function () {
        resizeTextarea(this);
      });

      // Handle Enter key
      textarea.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      var sendBtn = document.createElement('button');
      sendBtn.className = 'inline-bot-send-button';
      sendBtn.innerHTML = '→';
      sendBtn.disabled = isLoading;
      sendBtn.addEventListener('click', sendMessage);

      inputContainer.appendChild(textarea);
      inputContainer.appendChild(sendBtn);
      root.appendChild(inputContainer);

      // Lock current messages container height (fixed chat height like default state)
      // Do this on next frame to ensure layout is finalized
      if (fixedMessagesHeightPx === null) {
        requestAnimationFrame(function () {
          var container = root.querySelector('.inline-bot-messages');
          if (!container) return;
          fixedMessagesHeightPx = container.clientHeight;
          if (fixedMessagesHeightPx > 0) {
            container.style.height = fixedMessagesHeightPx + 'px';
            container.style.flex = 'none';
          }

          // Keep pinned to bottom when content grows (streaming)
          try {
            var mo = new MutationObserver(function () {
              if (shouldAutoScroll && !userHasScrolled) {
                container.scrollTop = container.scrollHeight;
              }
            });
            mo.observe(container, {childList: true, subtree: true, characterData: true});
          } catch (e) {}

          if (window.ResizeObserver) {
            try {
              var ro = new ResizeObserver(function () {
                if (shouldAutoScroll && !userHasScrolled) {
                  container.scrollTop = container.scrollHeight;
                }
              });
              ro.observe(container);
            } catch (e) {}
          }

          // Nudge scroll after images/fonts load to account for late layout shifts
          try {
            container.addEventListener('load', function (ev) {
              var target = ev.target || {};
              if (target.tagName === 'IMG' && shouldAutoScroll && !userHasScrolled) {
                container.scrollTop = container.scrollHeight;
              }
            }, true);
          } catch (e) {}

          try {
            if (document.fonts && document.fonts.ready) {
              document.fonts.ready.then(function () {
                if (shouldAutoScroll && !userHasScrolled) {
                  container.scrollTop = container.scrollHeight;
                }
              });
            }
          } catch (e) {}

          // Ensure initial position is bottom
          container.scrollTop = container.scrollHeight;
        });
      }
    }

    function sendMessage() {
      var textarea = root.querySelector('.inline-bot-input');
      var message = textarea.value.trim();
      if (!message || isLoading) return;

      // Add user message
      messages.push({type: 'user', content: message});
      textarea.value = '';
      textarea.style.height = '52px'; // Reset to fixed height

      // Add empty bot message for streaming
      var lastBotMessage = {type: 'bot', content: ''};
      messages.push(lastBotMessage);

      isLoading = true;

      // Enable auto-scroll for new message
      shouldAutoScroll = true;
      userHasScrolled = false;

      render();

      // Scroll to bottom when new question is asked
      scrollToBottom();
      // Send to API using POST request like other widgets
      var headers = {
        'Content-Type': 'application/json',
        'Accept': 'text/event-stream'
      };

      fetch(API_URL + '/companion-service/v1/organizations/' + ORGANIZATION_ID + '/conversations/stream', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({query: message, scope: 'chat'})
      }).then(function (res) {
        if (!res.ok) throw new Error('HTTP ' + res.status);
        var reader = res.body.getReader();
        var decoder = new TextDecoder();
        var buffer = '';

        function readChunk() {
          return reader.read().then(function (result) {
            var done = result.done;
            var value = result.value;

            if (done) {
              isLoading = false;
              render();
              return;
            }

            var chunk = decoder.decode(value, {stream: true});
            buffer += chunk;
            var lines = buffer.split('\n');
            buffer = lines.pop() || ''; // Keep incomplete line in buffer

            for (var i = 0; i < lines.length; i++) {
              var line = lines[i];
              if (line.startsWith('data:')) {
                try {
                  var jsonStr = line.substring(5).trim();
                  if (jsonStr && jsonStr !== '[DONE]') {
                    var data = JSON.parse(jsonStr);

                    // Check for errors using the same logic as Search and Companion Bot widgets
                    if (data.isError || data.error) {
                      lastBotMessage.content = data.error || data.message || 'An error occurred';
                      lastBotMessage.isError = true;
                    } else if (data.response) {
                      lastBotMessage.content = data.response;
                      lastBotMessage.references = data.references;
                    }

                    render();
                  }
                } catch (e) {
                  console.error('Error parsing SSE data:', e);
                }
              }
            }

            return readChunk();
          });
        }

        return readChunk();
      }).catch(function (error) {
        console.error('Fetch error:', error);
        isLoading = false;
        if (!lastBotMessage.content) {
          lastBotMessage.content = 'Sorry, I encountered an error. Please try again.';
          lastBotMessage.isError = true;
        }
        render();
      });
    }

    function formatMessageContent(content, references) {
      if (!content) return '';
      var result = content.replace(/\n/g, '<br>');

      // Convert Context[#] to clickable links
      if (references && references.length > 0) {
        // Prepare URLs
        // Parse ["Title", "URL"] even if title contains quotes
        result = result
          // JSON-style: ["Title", "https://url"] — strict, non-greedy
          .replace(
            /\[\s*(['"])(.*?)\1\s*,\s*(?:(['"])?((?:https?:\/\/)[^\s'"\]\n]+)\3?)\s*\]/g,
            function (_match, _q1, rawTitle, _q2, rawUrl) {
              var title = rawTitle.replace(/\\(['"])/g, '$1'); // unescape quotes
              var url = rawUrl;
              return '<a href="' + url + '" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: none;">' + title + '</a>';
            }
          )
          // Markdown-style: [Title](https://url)
          .replace(
            /\[([^\]]+?)\]\((https?:\/\/[^\s)]+)\)/g,
            function (_match, title, url) {
              return '<a href="' + url + '" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: none;">' + title + '</a>';
            }
          );
      }

      return result;
    }

    function smartScroll() {
      var messagesContainer = root.querySelector('.inline-bot-messages');
      if (!messagesContainer) return;
      if (shouldAutoScroll && !userHasScrolled) {
        if (isLoading) {
          // During streaming, snap to bottom to avoid jitter
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        } else {
          // After completion, smooth to bottom once
          messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: 'smooth'
          });
        }
      }
    }

    function scrollToBottom() {
      // Force scroll to bottom (for new messages)
      var messagesContainer = root.querySelector('.inline-bot-messages');
      if (messagesContainer) {
        if (isLoading) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        } else {
          messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: 'smooth'
          });
        }
      }
    }

    function updateMessagesOnly(messagesContainer) {
      messagesContainer.innerHTML = '';

      if (messages.length === 0) {
        var welcomeMsg = document.createElement('div');
        welcomeMsg.className = 'inline-bot-welcome-message';
        welcomeMsg.textContent = 'Hello! How can I help you today?';
        messagesContainer.appendChild(welcomeMsg);
      } else {
        messages.forEach(function (msg, index) {
          var msgEl = document.createElement('div');
          msgEl.className = 'inline-bot-message ' + msg.type + (msg.isError ? ' error' : '');

          var content = document.createElement('div');
          content.className = 'inline-bot-message-content';

          // Show typing indicator for last bot message when loading
          if (msg.type === 'bot' && index === messages.length - 1 && isLoading && !msg.content) {
            var typingIndicator = document.createElement('div');
            typingIndicator.className = 'inline-bot-typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            content.appendChild(typingIndicator);
          } else {
            content.innerHTML = formatMessageContent(msg.content || '', msg.references);
          }

          msgEl.appendChild(content);

          // Add references section for bot messages (only after streaming completes)
          if (msg.type === 'bot' && msg.references && msg.references.length > 0 && !(index === messages.length - 1 && isLoading)) {
            var referencesSection = document.createElement('div');
            referencesSection.className = 'references';
            referencesSection.style.cssText = '\
                        margin-top: 8px;\
                        padding-top: 8px;\
                        border-top: 1px solid #e5e7eb;\
                        color: #6b7280;';

            var referencesTitle = document.createElement('strong');
            referencesTitle.textContent = 'Related:';
            referencesTitle.style.cssText = 'color: #374151; display: block; margin-bottom: 4px;';
            referencesSection.appendChild(referencesTitle);

            var referencesList = document.createElement('ol');
            referencesList.style.cssText = '\
                        margin: 0;\
                        padding-left: 16px;\
                        color: #374151;';

            var maxVisible = 2;
            var hasMore = msg.references.length > maxVisible;

            // Show first 2 references
            msg.references.slice(0, maxVisible).forEach(function (ref) {
              var listItem = document.createElement('li');
              listItem.style.cssText = 'margin-bottom: 2px;';

              var anchor = document.createElement('a');
              anchor.href = ref;
              anchor.target = '_blank';
              anchor.rel = 'noopener noreferrer';
              anchor.textContent = ref;
              anchor.style.cssText = '\
                            color: #667eea;\
                            text-decoration: none;\
                            word-break: break-all;';

              anchor.addEventListener('mouseenter', function () {
                this.style.textDecoration = 'underline';
              });

              anchor.addEventListener('mouseleave', function () {
                this.style.textDecoration = 'none';
              });

              listItem.appendChild(anchor);
              referencesList.appendChild(listItem);
            });

            // Add "More..." link if there are additional references
            if (hasMore) {
              var moreItem = document.createElement('li');
              moreItem.style.cssText = 'margin-bottom: 2px;';

              var moreLink = document.createElement('a');
              moreLink.href = '#';
              moreLink.textContent = 'More... (' + (msg.references.length - maxVisible) + ' additional)';

              moreLink.addEventListener('mouseenter', function () {
                this.style.textDecoration = 'underline';
              });

              moreLink.addEventListener('mouseleave', function () {
                this.style.textDecoration = 'none';
              });

              moreLink.addEventListener('click', function (e) {
                e.preventDefault();

                // Remove the "More..." item
                referencesList.removeChild(moreItem);

                // Add remaining references
                msg.references.slice(maxVisible).forEach(function (ref) {
                  var listItem = document.createElement('li');
                  listItem.style.cssText = 'margin-bottom: 2px;';

                  var anchor = document.createElement('a');
                  anchor.href = ref;
                  anchor.target = '_blank';
                  anchor.rel = 'noopener noreferrer';
                  anchor.textContent = ref;
                  anchor.style.cssText = '\
                                    text-decoration: none;\
                                    word-break: break-all;';

                  anchor.addEventListener('mouseenter', function () {
                    this.style.textDecoration = 'underline';
                  });

                  anchor.addEventListener('mouseleave', function () {
                    this.style.textDecoration = 'none';
                  });

                  listItem.appendChild(anchor);
                  referencesList.appendChild(listItem);
                });
              });

              moreItem.appendChild(moreLink);
              referencesList.appendChild(moreItem);
            }

            referencesSection.appendChild(referencesList);
            content.appendChild(referencesSection);
          }

          msgEl.appendChild(content);
          messagesContainer.appendChild(msgEl);
        });
      }
    }

    function updateSendButtonState() {
      var sendBtn = root.querySelector('.inline-bot-send-button');
      if (sendBtn) {
        sendBtn.disabled = isLoading;
        if (isLoading) {
          sendBtn.style.background = '#d1d5db';
          sendBtn.style.cursor = 'not-allowed';
        } else {
          sendBtn.style.cursor = 'pointer';
        }
      }
    }
  })();
</script>
