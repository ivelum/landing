{{/* Input parameters: */}}
{{- $originalImg := .Img }}
{{- $alt := .Alt }}
{{- $class := .Class }}
{{- $width := .Width -}}

{{- $mediaType := $originalImg.MediaType.SubType -}}

{{- $img1x := $originalImg }}
{{- $img2x := false }}
{{- if and (ne $mediaType "svg") (gt $originalImg.Width $width) }}
  {{- $img1x = $originalImg.Resize (printf "%dx" $width) }}
  {{- $width2x := mul $width 2 }}
  {{- if gt $originalImg.Width $width2x }}
    {{- $img2x = $originalImg.Resize (printf "%dx" $width2x) }}
  {{- else }}
    {{- $img2x = $originalImg }}
  {{- end }}
{{- end -}}

{{- $img1xWebp := false }}
{{- $img2xWebp := false }}
{{- if and (ne $mediaType "svg") (ne $mediaType "webp") }}
  {{- $img1xWebp = $img1x.Process "webp" }}
  {{- with $img2x }}
    {{- $img2xWebp = .Process "webp" }}
  {{- end }}
{{- end -}}

{{- if or $img1xWebp $img2x -}}
  <picture>
  {{- if $img1xWebp -}}
    <source srcset="{{ $img1xWebp.RelPermalink }}{{ with $img2xWebp }}, {{ .RelPermalink }} 2x{{ end }}" type="image/webp">
  {{- end -}}
    <img width="{{ $width }}"{{ with $class }} class="{{ . }}"{{ end }} src="{{ $img1x.RelPermalink }}"{{ with $img2x }} srcset="{{ .RelPermalink }} 2x"{{ end }} alt="{{ $alt }}"></picture>
{{- else -}}
  <img width="{{ $width }}"{{ with $class }} class="{{ . }}"{{ end }} src="{{ $originalImg.RelPermalink }}" alt="{{ $alt }}">
{{- end -}}
