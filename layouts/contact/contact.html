{{ define "main" }}
  <div class="page contact">
    <div class="container">
      <h1 class="contact--title">Contact</h1>

      <div class="contact--address-wrapper">
        {{- range sort (where .Pages "Params.category" "address") "File.Path" }}
        <div class="contact--address-item">
          <h3 class="contact--address-title">{{ .Title }}</h3>
          {{ .Content }}
        </div>
        {{- end }}
      </div>

      <div class="contact--wrapper">
        <div class="contact--inner">
          <div class="contact--method-title">
            <img
              src="{{ (.Resources.Get "img/live-chat.svg").RelPermalink }}"
              alt="Live chat"
            />
            Live chat
          </div>
          <p>
            We're online from 10 AM to 8 PM, EET<br />
            <span x-data="ChatStatus">
              <span x-text="localTime()"></span><br />
              <span
                class="contact--chatbox-status"
                x-bind:class="isOnline() ? 'is-online' : 'is-offline'"
                x-text="currentStatus()"
              ></span>
            </span>
          </p>
          <button
            class="btn btn-outline-violet btn-small"
            type="button"
            x-data="ChatButton"
            x-on:click="openChat"
          >
            Chat now
          </button>
        </div>
        <div class="contact--inner">
          <div class="contact--method-title">
            <img
              src="{{
                (.Resources.Get "img/free-consultation.svg").RelPermalink
              }}"
              alt="30-min free consultation"
            />
            30-min free consultation
          </div>
          <p>
            Tell us about your project! Together, we'll brainstorm the optimal
            approach and how we can help.
          </p>
          <a class="btn btn-outline-violet btn-small" href="/consultation/">
            Schedule
          </a>
        </div>
      </div>

      <div class="contact--team-wrapper">
        <div class="contact--team-text">
          <img
            src="{{ (.Resources.Get "img/globe.svg").RelPermalink }}"
            alt="Our team is distributed across 12 countries"
            class="contact--team-ico"
          />
          {{- .Content -}}
        </div>
        <ul class="contact--team-flags">
        {{- range .Resources.Match "img/flags/*.svg" }}
          {{- $country := path.BaseName .Name }}
          <li class="contact--team-flag">
            <img
              src="{{ .RelPermalink }}"
              width="20"
              height="20"
              alt="{{ $country }}"
            /> {{ $country }}
          </li>
        {{- end }}
        </ul>
      </div>
    </div>
  </div>

  <script type="module">
    import Alpine from 'alpinejs';

    document.addEventListener('alpine:init', () => {
      Alpine.data('ChatButton', () => ({ openChat }));
    });

    function openChat() {
      initChat();
      window.$crisp.push(['do', 'chat:show']);
      window.$crisp.push(['do', 'chat:open']);
    }

    function initChat() {
      if (window.CRISP_WEBSITE_ID) return;
      window.$crisp = [];
      window.CRISP_WEBSITE_ID = '2aa7bcb2-8094-4624-b64e-112c2ca3a174';

      const script = document.createElement('script');
      script.src = 'https://client.crisp.chat/l.js';
      script.async = 1;
      document.getElementsByTagName('head')[0].appendChild(script);
    }

    document.addEventListener('alpine:init', () => {
      Alpine.data('ChatStatus', () => {
        const startWorkHour = 10; // Start of working hours in Vilnius
        const endWorkHour = 20; // End of working hours in Vilnius

        const date = new Date();
        const utcDate = new Date(
          date.toLocaleString('en-US', { timeZone: 'UTC' }),
        );
        const vilDate = new Date(
          date.toLocaleString('en-US', { timeZone: 'Europe/Vilnius' }),
        );
        const vilOffset = (vilDate.getTime() - utcDate.getTime()) / 3600000;
        const localOffset = -new Date().getTimezoneOffset() / 60;

        const formatHours = (hourString) => {
          const hour = +hourString % 24;
          return (hour % 12 || 12) + (hour < 12 ? ' AM' : ' PM');
        };

        const getLocalDate = (hour) => {
          const dt = new Date();
          dt.setUTCHours(hour - vilOffset);
          dt.setMinutes(0);
          return new Date(dt.toLocaleString('en-US')).toString();
        };

        const localStart = getLocalDate(startWorkHour);
        const localEnd = getLocalDate(endWorkHour);

        const localTime = () => {
          if (vilOffset === localOffset) return 'matches your time zone';
          const start = formatHours(new Date(localStart).getHours());
          const end = formatHours(new Date(localEnd).getHours());
          return `(${start} â€“ ${end} your time zone)`;
        };

        const isOnline = () => {
          const current = new Date();
          const start = new Date(localStart);
          const end = new Date(localEnd);
          return (start <= current && current < end);
        };

        const currentStatus = () => {
          return `Currently ${isOnline() ? 'online' : 'offline'}`;
        }

        return { localTime, isOnline, currentStatus };
      });
    });
  </script>
{{- end }}
